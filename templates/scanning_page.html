{% extends 'base.html' %}
{% load static %}

{% block title %}Barcode Scanner{% endblock %}

{% block content %}

<head>
    <script src="https://unpkg.com/@ericblade/quagga2@latest/dist/quagga.min.js"></script>

</head>
<div class="container mx-auto mt-10">
    <h2 class="text-center text-2xl font-bold mb-4">Scan Product Barcode</h2>
    <div id="scanner-container" class="bg-gray-100 p-4 rounded-lg">
        <!-- Camera view will be displayed here -->
    </div>
    <button id="startButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4">
        Start Scanning
    </button>

    <div id="nutrinionalDiv" class="text-lg font-primary font-semibold">

        <p id="modifyText"></p>

    </div>
</div>

<script>
    document.getElementById('startButton').addEventListener('click', function() {
        // Initialize QuaggaJS and start the camera
        Quagga.init({
            inputStream : {
                name : "Live",
                type : "LiveStream",
                target: document.querySelector('#scanner-container')    
            },
            decoder : {
                readers : ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
            }
        }, function(err) {
            if (err) {
                console.error(err);
                return;
            }
            Quagga.start();
        });

        // Process the scanned barcode
        Quagga.onDetected(function(data) {
            alert("Barcode detected: " + data.codeResult.code);
            onBarcodeDetected(code)
        });
    });
    
</script>

<script>
    function onBarcodeDetected(barcode) {
    // Perform AJAX request to the server
    fetch('/health/api/barcode_info/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 'barcode': barcode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error:', data.error);
            // Display error message on the page
            document.getElementById('modifyText').innerText = 'Error: ' + data.error;
        } else {
            console.log('Product Name:', data.product_name);
            console.log('Nutritional Info:', data.nutritional_info);

            // Construct a string to display
            let displayText = `Product Name: ${data.product_name}\n`;
            displayText += 'Nutritional Information:\n';

            // Append nutritional information
            for (const [key, value] of Object.entries(data.nutritional_info)) {
                displayText += `${key}: ${value}\n`;
            }

            // Update the paragraph content
            document.getElementById('modifyText').innerText = displayText;
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        document.getElementById('modifyText').innerText = 'Error: ' + error;
    });
}

</script>
{% endblock %}
